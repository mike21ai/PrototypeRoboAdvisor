<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGoal - AI Financial Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .active { display: block; }
        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background-color: rgba(0, 0, 0, 0.5); 
            display: flex; align-items: center; justify-content: center; 
            z-index: 50;
        }
        @keyframes fill-progress { from { width: 0%; } }
        .progress-bar-fill { animation: fill-progress 1.5s ease-out forwards; }
        .bottom-nav-item.active svg,
        .bottom-nav-item.active p { 
            color: #2563eb; 
        }
        .bottom-nav-item.active p {
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="max-w-md mx-auto bg-white min-h-screen shadow-lg">
        
        <!-- Onboarding (Splash & Profiling) -->
        <div id="onboarding-wrapper">
            <!-- ===== SCREEN 1: SPLASH SCREEN (Dynamic) ===== -->
            <section id="splashScreen" class="flex flex-col items-center justify-center min-h-screen p-8 text-center bg-blue-600 text-white">
                <i data-lucide="target" class="w-24 h-24 mb-6"></i>
                <h1 class="text-4xl font-bold">MyGoal</h1>
                <p class="text-lg mt-2 opacity-90">Wujudkan Impian Finansialmu dengan Cerdas</p>
                <a href="#profilingSection" class="mt-12 bg-white text-blue-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition-transform transform hover:scale-105">Mulai Sekarang</a>
            </section>

            <!-- ===== SCREEN 2 & 3: PROFILING & FINANCIAL CHECK ( digabung dalam 1 section)===== -->
            <section id="profilingSection" class="p-6">
                <div class="py-12">
                    <h2 class="text-2xl font-bold mb-1">Langkah 1: Kenali Profil Risikomu</h2>
                    <p class="text-gray-600 mb-6">Jawab beberapa pertanyaan untuk personalisasi investasimu.</p>
                    <form id="quizForm" class="space-y-6">
                        <div>
                            <label class="font-semibold block mb-2">1. Jika investasimu turun 20% dalam sebulan, apa reaksimu?</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q1" value="1" class="mr-3" required> Jual semua, saya tidak bisa rugi.</label>
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q1" value="2" class="mr-3"> Cemas, tapi akan saya tahan.</label>
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q1" value="3" class="mr-3"> Biasa saja, ini kesempatan untuk beli lagi.</label>
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold block mb-2">2. Apa tujuan utamamu berinvestasi?</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q2" value="1" class="mr-3" required> Mengamankan nilai uang dari inflasi.</label>
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q2" value="2" class="mr-3"> Pertumbuhan seimbang.</label>
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q2" value="3" class="mr-3"> Keuntungan maksimal.</label>
                            </div>
                        </div>
                        <div>
                            <label class="font-semibold block mb-2">3. Pengalamanmu berinvestasi?</label>
                            <div class="space-y-2">
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q3" value="1" class="mr-3" required> Baru mulai.</label>
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q3" value="2" class="mr-3"> Kurang dari 3 tahun.</label>
                                <label class="flex items-center p-3 border rounded-lg hover:bg-blue-50"><input type="radio" name="q3" value="3" class="mr-3"> Lebih dari 3 tahun.</label>
                            </div>
                        </div>
                    </form>
                    
                    <hr class="my-12">

                    <h2 class="text-2xl font-bold mb-1">Langkah 2: Cek Kondisi Keuanganmu</h2>
                    <p class="text-gray-600 mb-6">Data ini membantu kami memberikan rekomendasi yang realistis. (Estimasi saja)</p>
                    <form id="financialForm" class="space-y-4">
                        <div><label for="monthlyIncome" class="font-semibold block mb-1">Pendapatan Per Bulan (Rp)</label><input type="number" id="monthlyIncome" class="w-full border rounded-lg p-3" placeholder="Contoh: 10000000" required></div>
                        <div><label for="monthlyExpenses" class="font-semibold block mb-1">Pengeluaran Rutin Per Bulan (Rp)</label><input type="number" id="monthlyExpenses" class="w-full border rounded-lg p-3" placeholder="Contoh: 6000000" required></div>
                        <button type="button" onclick="finishOnboarding()" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700">Selesai & Masuk Aplikasi</button>
                    </form>
                </div>
            </section>
        </div>

        <!-- Main Application (hidden initially) -->
        <div id="main-app" class="hidden pb-20">
            <div id="dashboardScreen" class="screen"></div>
            <div id="roadmapScreen" class="screen"></div>
            <div id="goalCreationScreen" class="screen"></div>
            <div id="goalDetailScreen" class="screen"></div>
            <div id="planScreen" class="screen"></div>

            <footer id="bottomNav" class="fixed bottom-0 left-1/2 -translate-x-1/2 max-w-md w-full bg-white border-t grid grid-cols-3 items-center z-20">
                <div id="nav-dashboardScreen" onclick="changeTab('dashboardScreen')" class="bottom-nav-item flex flex-col items-center justify-center p-2 cursor-pointer text-gray-500">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i><p class="text-xs">Dashboard</p>
                </div>
                <div class="flex justify-center">
                    <button onclick="showScreen('goalCreationScreen')" class="w-14 h-14 bg-blue-600 text-white rounded-full flex items-center justify-center -mt-6 shadow-lg"><i data-lucide="plus" class="w-8 h-8"></i></button>
                </div>
                <div id="nav-roadmapScreen" onclick="changeTab('roadmapScreen')" class="bottom-nav-item flex flex-col items-center justify-center p-2 cursor-pointer text-gray-500">
                    <i data-lucide="check-square" class="w-6 h-6"></i><p class="text-xs">Rencana Aksi</p>
                </div>
            </footer>
        </div>

        <!-- MODAL -->
        <div id="educationModal" class="modal-overlay hidden" onclick="showEducationModal(false)">
            <div class="bg-white rounded-lg shadow-xl p-6 m-4 max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 class="text-lg font-bold mb-2">Mengapa Alokasinya Seperti Ini?</h3>
                <p class="text-sm text-gray-600">Alokasi aset disesuaikan dengan <strong>profil risiko</strong> dan <strong>jangka waktu</strong> tujuanmu.</p>
                <ul class="text-sm text-gray-600 list-disc list-inside mt-2 space-y-1">
                    <li><strong>Jangka Panjang & Agresif:</strong> Porsi saham lebih besar untuk potensi imbal hasil maksimal.</li>
                    <li><strong>Jangka Pendek & Konservatif:</strong> Porsi pasar uang dan obligasi lebih besar untuk menjaga stabilitas.</li>
                </ul>
                <button onclick="showEducationModal(false)" class="w-full mt-4 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Mengerti</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        const appState = {
            userProfile: null, financialProfile: null,
            goals: [{ name: "Membeli Rumah Pertama", target: 300000000, current: 15750000, years: 7, icon: 'home' }],
            achievements: [], activePlan: {},
            roadmap: { monthlyDepositDue: true }, depositStreak: 0
        };
        let portfolioChartInstance, projectionChartInstance;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        const getTerm = (years) => {
            if (years <= 3) return `<div class="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Pendek</div>`;
            if (years <= 10) return `<div class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Menengah</div>`;
            return `<div class="bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Panjang</div>`;
        };

        // --- NAVIGATION & MODALS ---
        function showScreen(screenId) {
            document.querySelectorAll('#main-app .screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            window.scrollTo(0, 0);
        }
        function changeTab(screenId) {
            showScreen(screenId);
            document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
            document.getElementById(`nav-${screenId}`).classList.add('active');
        }
        function showEducationModal(show) { document.getElementById('educationModal').classList.toggle('hidden', !show); }

        // --- CORE LOGIC ---
        function finishOnboarding() {
            const quizForm = document.getElementById('quizForm');
            const financialForm = document.getElementById('financialForm');

            if (!quizForm.checkValidity() || !financialForm.checkValidity()) {
                alert('Mohon lengkapi semua data pada Langkah 1 dan 2.');
                return;
            }

            // Calculate Profile
            const score = Array.from(new FormData(quizForm).values()).reduce((sum, val) => sum + parseInt(val), 0);
            if (score <= 4) appState.userProfile = 'Konservatif';
            else if (score <= 7) appState.userProfile = 'Moderat';
            else appState.userProfile = 'Agresif';
            
            // Calculate Financial Health
            const income = parseFloat(document.getElementById('monthlyIncome').value);
            const expenses = parseFloat(document.getElementById('monthlyExpenses').value);
            appState.financialProfile = { income, expenses, capacity: income - expenses };

            // Transition to main app
            document.getElementById('onboarding-wrapper').style.display = 'none';
            document.getElementById('main-app').classList.remove('hidden');
            
            // Initialize main app view
            renderAllScreens();
            changeTab('dashboardScreen');
        }

        function selectGoalTemplate(name, icon) {
            renderGoalDetailScreen(name, icon);
            showScreen('goalDetailScreen');
        }

        function generatePlan() {
            const form = document.getElementById('goalDetailForm');
            if(!form.checkValidity()) { alert('Mohon isi semua field.'); return; }
            const goalName = document.getElementById('goalName').value;
            const goalAmount = parseFloat(document.getElementById('goalAmount').value);
            const goalYears = parseInt(document.getElementById('goalYears').value);
            const goalIcon = document.getElementById('goalIcon').value;

            const annualReturnRates = { 'Konservatif': 0.05, 'Moderat': 0.08, 'Agresif': 0.12 };
            const r = (annualReturnRates[appState.userProfile] || 0.08) / 12;
            const n = goalYears * 12;
            const monthlyInvestment = (goalAmount * r) / (Math.pow(1 + r, n) - 1);
            
            Object.assign(appState.activePlan, { name: goalName, target: goalAmount, years: goalYears, icon: goalIcon, monthly: Math.round(monthlyInvestment) });
            
            let portfolio = {};
            if (appState.userProfile === 'Konservatif') portfolio = { 'Pasar Uang': 20, 'Obligasi': 60, 'Saham Domestik': 15, 'Saham Internasional': 5 };
            else if (appState.userProfile === 'Moderat') portfolio = { 'Pasar Uang': 10, 'Obligasi': 40, 'Saham Domestik': 35, 'Saham Internasional': 15 };
            else portfolio = { 'Pasar Uang': 5, 'Obligasi': 20, 'Saham Domestik': 50, 'Saham Internasional': 25 };
            appState.activePlan.portfolio = portfolio;
            
            renderPlanScreen();
            showScreen('planScreen');
        }
        
        function completeMonthlyDeposit() {
            appState.roadmap.monthlyDepositDue = false;
            appState.depositStreak++;
            checkForAchievements();
            renderDashboardScreen();
            renderRoadmapScreen();
        }

        function addGoalAndReturnToDashboard() {
            appState.goals.push({ ...appState.activePlan, current: 0 });
            checkForAchievements();
            renderDashboardScreen();
            changeTab('dashboardScreen');
        }
        
        function checkForAchievements() {
            if (appState.goals.length > 1 && !appState.achievements.find(a => a.id === 'first_goal')) {
                appState.achievements.push({ id: 'first_goal', name: 'Langkah Pertama', icon: 'flag' });
            }
            if (appState.depositStreak === 1 && !appState.achievements.find(a => a.id === 'streak_1')) {
                appState.achievements.push({ id: 'streak_1', name: 'Konsisten!', icon: 'flame' });
            }
        }

        // --- DYNAMIC CONTENT RENDERING ---
        function renderAllScreens(){
            renderDashboardScreen();
            renderRoadmapScreen();
            renderGoalCreationScreen();
            // Detail and Plan screen rendered on demand
        }

        function renderDashboardScreen() {
            const container = document.getElementById('dashboardScreen');
            const totalAssets = appState.goals.reduce((sum, goal) => sum + goal.current, 0);

            let goalsHTML = appState.goals.map(goal => {
                const progress = goal.target > 0 ? (goal.current / goal.target) * 100 : 0;
                return `<div class="bg-white border rounded-lg p-4 shadow-sm flex items-center space-x-4">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center flex-shrink-0"><i data-lucide="${goal.icon || 'target'}"></i></div>
                    <div class="flex-grow">
                        <div class="flex justify-between items-start">
                            <div><p class="font-bold capitalize">${goal.name}</p><p class="text-sm text-gray-500">Target: ${formatCurrency(goal.target)}</p></div>
                            ${getTerm(goal.years)}
                        </div>
                        <div class="mt-2">
                            <div class="flex justify-between text-xs mb-1">
                                <span class="font-semibold text-blue-700">${formatCurrency(goal.current)}</span>
                                <span class="text-gray-500">${progress.toFixed(1)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full progress-bar-fill" style="width: ${progress}%"></div></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            let achievementsHTML = appState.achievements.map(ach => `
                <div class="flex flex-col items-center text-center w-20 flex-shrink-0">
                    <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mb-1"><i data-lucide="${ach.icon}"></i></div>
                    <p class="text-xs font-semibold">${ach.name}</p>
                </div>
            `).join('');

            container.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h1 class="text-2xl font-bold">Halo, Investor!</h1>
                            <p class="text-gray-600">Profil: <span class="font-semibold text-blue-600">${appState.userProfile}</span></p>
                        </div>
                        <div class="relative">
                            <i data-lucide="bell" class="text-gray-500 cursor-pointer" onclick="changeTab('roadmapScreen')"></i>
                            <div class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white ${appState.roadmap.monthlyDepositDue ? '' : 'hidden'}"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h3 class="font-semibold text-blue-800 text-sm">Total Aset</h3>
                            <p class="text-2xl font-bold text-blue-900 mt-1">${formatCurrency(totalAssets)}</p>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h3 class="font-semibold text-green-800 text-sm">Kemampuan Investasi</h3>
                            <p class="text-2xl font-bold text-green-900 mt-1">${formatCurrency(appState.financialProfile.capacity)}/bln</p>
                        </div>
                    </div>
                    ${appState.achievements.length > 0 ? `
                    <div class="mb-6">
                        <h3 class="text-xl font-bold mb-4">Pencapaianmu</h3>
                        <div class="flex space-x-4 overflow-x-auto pb-2">${achievementsHTML}</div>
                    </div>` : ''}
                    <h3 class="text-xl font-bold mb-4">Tujuan Finansialmu</h3>
                    <div class="space-y-4">${goalsHTML}</div>
                </div>
            `;
            lucide.createIcons();
        }
        
        function renderRoadmapScreen() {
            const container = document.getElementById('roadmapScreen');
            container.innerHTML = `<div class="p-6">
                <h2 class="text-2xl font-bold mb-1">Rencana Aksimu</h2>
                <p class="text-gray-600 mb-6">Checklist bulanan agar kamu tetap di jalur yang benar.</p>
                <div class="space-y-4">
                    ${appState.roadmap.monthlyDepositDue ? `
                    <div class="bg-white border rounded-lg p-4 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i data-lucide="calendar" class="w-6 h-6 mr-3 text-blue-500"></i>
                                <div><p class="font-bold">Setoran Rutin Bulan Ini</p><p class="text-sm text-gray-500">Ayo jaga konsistensimu!</p></div>
                            </div>
                            <button onclick="completeMonthlyDeposit()" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">Selesaikan</button>
                        </div>
                    </div>` : `
                    <div class="bg-green-50 border border-green-200 text-green-800 rounded-lg p-4 text-center">
                        <p class="font-semibold">Hebat! Semua aksimu untuk bulan ini sudah selesai.</p>
                    </div>`}
                </div>
            </div>`;
            lucide.createIcons();
        }

        function renderGoalCreationScreen() {
            const container = document.getElementById('goalCreationScreen');
            const templates = [ { name: 'Dana Darurat', icon: 'shield-alert' }, { name: 'DP Properti', icon: 'home' }, { name: 'Menikah', icon: 'heart' }, { name: 'Kendaraan', icon: 'car' }, { name: 'Pendidikan Anak', icon: 'graduation-cap' }, { name: 'Dana Pensiun', icon: 'gem' }, { name: 'Liburan', icon: 'plane' }, { name: 'Barang Impian', icon: 'shopping-bag' }, { name: 'Lainnya', icon: 'plus-circle' } ];
            
            let templatesHTML = templates.map(t => `
                <div class="flex flex-col items-center justify-center p-4 border rounded-lg hover:bg-blue-50 cursor-pointer" onclick="selectGoalTemplate('${t.name}', '${t.icon}')">
                    <i data-lucide="${t.icon}" class="w-8 h-8 mb-2 text-blue-600"></i><p class="text-sm font-semibold">${t.name}</p>
                </div>
            `).join('');

            container.innerHTML = `<div class="p-6">
                <button onclick="changeTab('dashboardScreen')" class="text-gray-600 hover:text-gray-900 mb-4"><i data-lucide="arrow-left" class="inline-block"></i> Kembali</button>
                <h2 class="text-2xl font-bold mb-1">Pilih Jenis Mimpimu</h2>
                <p class="text-gray-600 mb-6">Kami akan siapkan template untukmu.</p>
                <div class="grid grid-cols-3 gap-4 text-center">${templatesHTML}</div>
            </div>`;
            lucide.createIcons();
        }

        function renderGoalDetailScreen(name, icon) {
            const container = document.getElementById('goalDetailScreen');
            container.innerHTML = `<div class="p-6">
                <button onclick="showScreen('goalCreationScreen')" class="text-gray-600 hover:text-gray-900 mb-4"><i data-lucide="arrow-left" class="inline-block"></i> Kembali</button>
                <h2 class="text-2xl font-bold mb-1">Detail Mimpimu: ${name}</h2>
                <p class="text-gray-600 mb-6">Isi detailnya untuk membuat rencana.</p>
                <form id="goalDetailForm" class="space-y-4">
                    <input type="hidden" id="goalIcon" value="${icon}">
                    <div><label for="goalName" class="font-semibold block mb-1">Nama Tujuan</label><input type="text" id="goalName" value="${name}" class="w-full border rounded-lg p-3" required></div>
                    <div><label for="goalAmount" class="font-semibold block mb-1">Target Dana (Rp)</label><input type="number" id="goalAmount" class="w-full border rounded-lg p-3" placeholder="Contoh: 300000000" required></div>
                    <div><label for="goalYears" class="font-semibold block mb-1">Jangka Waktu (Tahun)</label><input type="number" id="goalYears" class="w-full border rounded-lg p-3" placeholder="Contoh: 5" required></div>
                    <button type="button" onclick="generatePlan()" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-blue-700">Buat Rencana Investasi</button>
                </form>
            </div>`;
            lucide.createIcons();
        }

        function renderPlanScreen() {
            const container = document.getElementById('planScreen');
            const plan = appState.activePlan;
            const capacity = appState.financialProfile.capacity;
            let capacityFeedbackHTML = '';

            if (plan.monthly <= capacity) {
                capacityFeedbackHTML = `<div class="mb-6 p-3 rounded-lg text-sm text-center bg-green-100 text-green-800">
                    <i data-lucide="check-circle" class="inline-block w-4 h-4 mr-1"></i> Rencana ini <strong>sesuai</strong> dengan kemampuan investasimu.
                </div>`;
            } else {
                capacityFeedbackHTML = `<div class="mb-6 p-3 rounded-lg text-sm text-center bg-yellow-100 text-yellow-800">
                    <i data-lucide="alert-triangle" class="inline-block w-4 h-4 mr-1"></i> Setoran ini <strong>di atas</strong> kemampuan investasimu. Pastikan keuanganmu tetap sehat.
                </div>`;
            }

            container.innerHTML = `<div class="p-6">
                <button onclick="addGoalAndReturnToDashboard()" class="text-gray-600 hover:text-gray-900 mb-4"><i data-lucide="arrow-left" class="inline-block"></i> Kembali</button>
                <h2 class="text-2xl font-bold mb-1">Rencana Investasimu</h2>
                <p class="text-gray-600 mb-6">Rekomendasi cerdas untuk tujuan <strong class="capitalize text-blue-600">${plan.name}</strong>.</p>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center mb-6">
                    <p class="text-blue-800">Kamu perlu berinvestasi:</p>
                    <p class="text-3xl font-bold text-blue-900 my-2">${formatCurrency(plan.monthly)} / bulan</p>
                    <p class="text-sm text-gray-600">Untuk mencapai <strong>${formatCurrency(plan.target)}</strong> dalam <strong>${plan.years}</strong> tahun.</p>
                </div>
                ${capacityFeedbackHTML}
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-2 flex items-center">Rekomendasi Alokasi Aset <i data-lucide="info" class="w-4 h-4 ml-2 text-gray-400 cursor-pointer" onclick="showEducationModal(true)"></i></h3>
                    <p class="text-gray-600 mb-4 text-sm">Berdasarkan profil (<span class="font-semibold">${appState.userProfile}</span>) dan jangka waktu.</p>
                    <div class="max-w-xs mx-auto"><canvas id="portfolioChart"></canvas></div>
                    <div id="portfolioLegend" class="mt-4 space-y-2"></div>
                </div>
                <div class="border-t pt-6 mb-6">
                    <h3 class="text-xl font-bold mb-2">Simulasi "What-If"</h3>
                    <p class="text-gray-600 mb-4 text-sm">Lihat dampak perubahan setoran bulanan.</p>
                    <div>
                        <label for="simulationSlider" class="flex justify-between items-center font-semibold mb-1"><span>Setoran Bulanan</span><span id="simulationValue" class="text-blue-600"></span></label>
                        <input type="range" id="simulationSlider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <p id="simulationResult" class="text-center mt-3 font-semibold text-green-700"></p>
                    </div>
                </div>
                <div class="border-t pt-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">Proyeksi Hasil Investasimu</h3>
                    <div><canvas id="projectionChart"></canvas></div>
                </div>
                <button onclick="addGoalAndReturnToDashboard()" class="w-full mt-8 bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-green-700">Simpan & Mulai Investasi</button>
            </div>`;
            
            // Render charts and setup slider after innerHTML is set
            renderPortfolioChart(plan.portfolio);
            renderProjectionChart();
            setupSimulationSlider();
            lucide.createIcons();
        }
        
        function renderPortfolioChart(portfolioData) {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            const labels = Object.keys(portfolioData), data = Object.values(portfolioData);
            const colors = ['#f97316', '#3b82f6', '#16a34a', '#ef4444'];
            if (portfolioChartInstance) portfolioChartInstance.destroy();
            portfolioChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: colors, borderColor: '#fff', borderWidth: 4 }] }, options: { responsive: true, cutout: '70%', plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => `${c.label}: ${c.raw}%` } } } } });
            const legendContainer = document.getElementById('portfolioLegend');
            legendContainer.innerHTML = '';
            labels.forEach((label, i) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between text-sm';
                item.innerHTML = `<div class="flex items-center"><span class="w-3 h-3 rounded-full mr-2" style="background-color: ${colors[i]}"></span><span>${label}</span></div><span class="font-bold">${data[i]}%</span>`;
                legendContainer.appendChild(item);
            });
        }
        
        function renderProjectionChart() {
            const { years, monthly } = appState.activePlan;
            const baseRate = { 'Konservatif': 0.05, 'Moderat': 0.08, 'Agresif': 0.12 }[appState.userProfile] || 0.08;
            const project = rate => { let bal=0, bals=[0]; for(let y=0;y<years;y++){ bal=(bal+(monthly*12))*(1+rate); bals.push(bal); } return bals; };
            const labels = Array.from({ length: years + 1 }, (_, i) => `T${i}`);
            const datasets = [ { label: 'Pesimis', data: project(baseRate - 0.03), borderColor: '#ef4444', fill: false, tension: 0.1 }, { label: 'Normal', data: project(baseRate), borderColor: '#3b82f6', fill: false, tension: 0.1, borderWidth: 3 }, { label: 'Optimis', data: project(baseRate + 0.03), borderColor: '#16a34a', fill: false, tension: 0.1 } ];
            const ctx = document.getElementById('projectionChart').getContext('2d');
            if (projectionChartInstance) projectionChartInstance.destroy();
            projectionChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, scales: { y: { ticks: { callback: v => formatCurrency(v).replace(/\,00$/, '') } } }, plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.raw)}` } } } } });
        }
        
        function setupSimulationSlider() {
            const slider = document.getElementById('simulationSlider');
            const plan = appState.activePlan;
            slider.value = plan.monthly;
            slider.min = Math.max(100000, plan.monthly / 2);
            slider.max = Math.min(50000000, plan.monthly * 3);
            const updateSim = () => {
                const monthly = parseInt(slider.value);
                document.getElementById('simulationValue').textContent = formatCurrency(monthly);
                const { target, years } = appState.activePlan;
                const r = ({ 'Konservatif': 0.05, 'Moderat': 0.08, 'Agresif': 0.12 }[appState.userProfile] || 0.08) / 12;
                const n = Math.log((target * r / monthly) + 1) / Math.log(1 + r);
                const yearsSaved = years - (n / 12);
                document.getElementById('simulationResult').textContent = yearsSaved > 0.1 ? `Tujuan tercapai ${yearsSaved.toFixed(1)} tahun lebih cepat!` : `Ayo tingkatkan setoranmu!`;
            };
            slider.oninput = updateSim;
            updateSim();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>

